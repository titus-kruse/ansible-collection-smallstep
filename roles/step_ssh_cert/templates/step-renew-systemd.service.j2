[Unit]
Description=Certificate renewer
After=network-online.target
Documentation=https://smallstep.com/docs/step-ca/certificate-authority-server-production
StartLimitIntervalSec=0
PartOf=cert-renewer.target

[Service]
Type=oneshot
User=root

Environment=STEPPATH={{ step_ssh_cert_steppath }} \
            CERT_LOCATION={{ step_ssh_cert_certfile }} \
            KEY_LOCATION={{ step_ssh_cert_keyfile }}

; ExecCondition checks if the certificate is ready for renewal,
; based on the exit status of the command.
; (In systemd <242, you can use ExecStartPre= here.)
ExecCondition={{ _step_cli_executable_absolute.stdout }} ssh needs-renewal ${CERT_LOCATION}{% if step_ssh_cert_renewal_when is defined %} --expires-in {{ step_ssh_cert_renewal_when }}{% endif %}

; ExecStart renews the certificate, if ExecStartPre was successful.
ExecStart={{ _step_cli_executable_absolute.stdout }} ssh renew --force ${CERT_LOCATION} ${KEY_LOCATION}

; Try to reload or restart the systemd service that relies on this cert-renewer
; If the relying service doesn't exist, forge ahead.
; (In systemd <229, use `reload-or-try-restart` instead of `try-reload-or-restart`)
{% if step_ssh_cert_renewal_reload_services %}ExecStartPost=/usr/bin/env sh -c "systemctl try-reload-or-restart {{ step_ssh_cert_renewal_reload_services | join(' ') }}"{% endif %}

[Install]
WantedBy=multi-user.target
